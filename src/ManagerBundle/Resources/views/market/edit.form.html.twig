{% extends 'ManagerBundle:Layout:edit.form.html.twig' %}

{% block avanzu_head %}
    {{ parent() }}
    <style>
        .managerbundle-market-commissions-box-body {
            padding: 10px 20px;
        }

        .managerbundle-market-commissions-box-body .with-border {
            border-bottom: 1px solid #f4f4f4;
            padding-bottom: 10px;
        }

        #managerbundle_market_commissions {
            padding-top: 0;
        }

        #managerbundle_market_commissions .form-group {
            margin-left: 4px;
        }

        #managerbundle_market_commissions .entry-row {
            padding: 0;
        }

        #managerbundle_market_commissions .entry-row .entry {
            padding-left: 0px;
        }
    </style>
{% endblock %}

{% block avanzu_javascripts_inline %}
    {{ parent() }}
    <script>
        $(document).ready(function () {
            var $region = $('#managerbundle_market_region');
            // When region gets selected ...
            $region.change(function() {
                $('#managerbundle_market_country option')
                    .filter(function() {
                        console.log(this.value || $.trim(this.value).length > 0);
                        return this.value && this.value != 'Choose country';
                    })
                    .remove();

                $('managerbundle_market_country option')
                    .first()
                    .prop('selected', true);

                // ... retrieve the corresponding form.
                var $form = $(this).closest('form');
                // Simulate form data, but only include the selected region value.
                var data = {};
                data[$region.attr('name')] = $region.val();
                // Submit data via AJAX to the form's action path.
                $.ajax({
                    url : $form.attr('action'),
                    type: $form.attr('method'),
                    data : data,
                    success: function(html) {
                        // Replace current country field ...
                        $('#managerbundle_market_country').replaceWith(
                            // ... with the returned one from the AJAX response.
                            $(html).find('#managerbundle_market_country')
                        );
                        // Position field now displays the appropriate countrys.
                    }
                });
            });

            $('#managerbundle_market_name').change(function () {
                $('#managerbundle_market_alias').prop('placeholder', $(this).val())
            });
        });


        // keep track of how many email fields have been rendered
        var count = '{{ form.commissions|length }}';

        $(document).ready(function() {
            var commissions = $('#managerbundle_market_commissions');
            var addCommissions = $('#add-commissions');
            var table = $('#managerbundle_market_commissions table');

            addCommissions.click(function(e) {
                e.preventDefault();

                // grab the prototype template
                var newWidget = commissions.attr('data-prototype');
                // replace the "__name__" used in the id and name of the prototype
                // with a number that's unique to your emails
                // end name attribute looks like name="contact[emails][2]"
                newWidget = newWidget.replace(/__name__/g, count);
                count++;

                var commission = $(newWidget).appendTo(table);
                commission.children('.entry-buttons').each(function () {
                    addCommissionFormDeleteLink($(this));
                });
            });

            // add a delete link to all of the existing tag form div elements
            commissions.find('tr .entry-buttons').each(function() {
                addCommissionFormDeleteLink($(this));
            });
        });

        function addCommissionFormDeleteLink($widget) {
            var $removeFormA = $('<button type="button" class="btn btn-sm btn-icon btn-pure"><i class="fa fa-minus-square" aria-hidden="true"></i></button>');

            console.log($removeFormA.appendTo($widget));

            $removeFormA.on('click', function(e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                // remove the div for the tag form
                $widget.parent().remove();
            });
        }
    </script>
{% endblock %}